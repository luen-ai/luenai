<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>luen AI 관리자 - 실현수익 증감 적용</title>

  <link rel="icon" type="image/png" href="./favicon.png" />
  <link rel="apple-touch-icon" href="./favicon.png" />

  <style>
    * { box-sizing:border-box; }
    body{
      margin:0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: linear-gradient(135deg,#eef2ff,#fefce8);
      color:#0f172a;
      padding:18px;
    }
    .wrap{ max-width: 980px; margin:0 auto; }
    .card{
      background: rgba(255,255,255,.92);
      border:1px solid rgba(226,232,240,.9);
      border-radius:18px;
      box-shadow: 0 14px 40px rgba(148,163,184,.25);
      padding:16px;
      margin-bottom:14px;
    }
    .top{
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .brand{ font-weight:900; letter-spacing:.12em; }
    .brand span{ color:#4f46e5; }
    .btn{
      border:none; cursor:pointer;
      border-radius:999px;
      padding:10px 14px;
      background:#111827; color:#fff;
      font-weight:900;
    }
    .btn.secondary{ background:#f3f4f6; color:#111827; }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }

    .grid{
      display:grid; grid-template-columns: 1.2fr .8fr; gap:12px;
    }
    @media (max-width: 820px){
      .grid{ grid-template-columns: 1fr; }
    }

    label{ display:block; font-size:12px; color:#475569; margin:10px 0 6px; font-weight:800; }
    input{
      width:100%;
      border:1px solid #d1d5db;
      background:#fff;
      border-radius:12px;
      padding:11px 12px;
      font-size:14px;
      outline:none;
    }
    input:focus{ border-color:#6366f1; box-shadow:0 0 0 2px rgba(99,102,241,.18); }

    .row{
      display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end;
    }
    .row > div{ flex:1; min-width: 220px; }
    .help{ font-size:12px; color:#64748b; margin-top:8px; line-height:1.55; }

    .stat{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top:10px;
    }
    .stat .box{
      flex:1;
      min-width: 220px;
      background:#f8fafc;
      border:1px solid #e5e7eb;
      border-radius:14px;
      padding:12px;
    }
    .stat .k{ font-size:12px; color:#64748b; font-weight:800; }
    .stat .v{ font-size:22px; font-weight:900; margin-top:6px; }
    .v.positive{ color:#059669; }
    .v.negative{ color:#dc2626; }

    .pill{
      display:inline-flex; gap:6px; align-items:center;
      padding:4px 10px; border-radius:999px;
      font-size:12px; font-weight:900;
      background:#eef2ff; color:#4f46e5;
      border:1px solid rgba(79,70,229,.2);
    }

    .log{
      border-top:1px dashed #e5e7eb;
      margin-top:12px;
      padding-top:12px;
    }
    .log h3{ margin:0 0 10px; font-size:14px; font-weight:900; }
    .timeline{ display:flex; flex-direction:column; gap:8px; }
    .item{
      border:1px solid #e5e7eb;
      background:#fff;
      border-radius:12px;
      padding:10px 12px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
    }
    .item .left{ display:flex; flex-direction:column; gap:4px; }
    .item .date{ font-size:12px; color:#64748b; }
    .item .who{ font-size:13px; font-weight:900; color:#111827; }
    .item .amt{ font-size:14px; font-weight:900; }
    .amt.plus{ color:#059669; }
    .amt.minus{ color:#dc2626; }

    .error{
      display:none;
      margin-top:10px;
      color:#b91c1c;
      font-weight:900;
      font-size:13px;
    }
    .error.show{ display:block; }

    .ok{
      display:none;
      margin-top:10px;
      color:#166534;
      font-weight:900;
      font-size:13px;
    }
    .ok.show{ display:block; }

    .mini{
      font-size:12px; color:#64748b;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <div class="brand"><span>luen AI</span> ADMIN · 실현수익 증감</div>
        <div class="row" style="gap:8px;">
          
          <a class="btn secondary" href="dashboard.html" style="text-decoration:none; display:inline-flex; align-items:center; justify-content:center;">회원 & 투자 관리</a>
<button class="btn secondary" id="btnLogout" type="button">로그아웃</button>
        </div>
      </div>
      <div class="help">
        ✅ 실현수익은 “총 누적값”이라 직접 덮어쓰지 않고,<br/>
        <b>증감할 금액(원)</b>만 입력해서 <b>profit_logs</b>에 기록하면 트리거가 자동으로 <b>users.realized_amount</b>에 반영됩니다.
      </div>
    </div>

    <div class="grid">
      <!-- 왼쪽: 적용 UI -->
      <div class="card">
        <div class="pill">1) 유저 선택</div>

        <label for="username">유저 아이디(username)</label>
        <div class="row">
          <div style="flex:2; min-width:240px;">
            <input id="username" placeholder="예: luenai_user01" autocomplete="off" />
          </div>
          <div style="flex:1; min-width:160px;">
            <button class="btn secondary" id="btnFind" type="button">조회</button>
          </div>
        </div>

        <div class="stat" id="statArea" style="display:none;">
          <div class="box">
            <div class="k">이름</div>
            <div class="v" style="font-size:16px;" id="uName">-</div>
            <div class="mini" id="uId">user_id: -</div>
          </div>
          <div class="box">
            <div class="k">현재 실현수익(누적)</div>
            <div class="v" id="uRealized">-</div>
          </div>
        </div>

        <div style="margin-top:14px;" class="pill">2) 증감 적용</div>

        <label for="deltaAmount">증감할 금액(원)</label>
        <div class="row">
          <div>
            <input id="deltaAmount" type="text" inputmode="decimal" placeholder="예: 250000 또는 -250000" />
            <div class="mini" style="margin-top:6px;">
              숫자만 입력 후 <b>Enter</b> 또는 <b>확인</b>을 누르세요. (예: 250000 = 수익, -250000 = 손실)
            </div>
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <div style="flex:1; min-width:180px;">
            <button class="btn" id="btnApply" type="button" disabled>확인</button>
          </div>
        </div>

        <div class="ok" id="okBox">✅ 적용 완료</div>
        <div class="error" id="errBox">❌ 오류: -</div>

        <div class="help">
          ※ 전제 조건<br/>
          - <b>profit_logs(user_id uuid, amount_delta numeric/int, created_at)</b> 존재<br/>
          - profit_logs insert 시 <b>users.realized_amount</b> 업데이트하는 트리거가 이미 적용되어 있음<br/>
          - RLS 정책이 “어드민”이 profit_logs insert / users select 가능하도록 열려 있어야 함
        </div>
      </div>

      <!-- 오른쪽: 로그 타임라인 -->
      <div class="card">
        <div class="pill">수익 로그 타임라인 (최근 20건)</div>
        <div class="log">
          <h3 id="logTitle">선택된 유저: -</h3>
          <div class="timeline" id="timeline">
            <div class="mini">유저를 조회하면 최근 로그가 표시됩니다.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Supabase UMD -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

  <script>
    /********************
     * 0) Supabase 연결
     ********************/
    const supabaseUrl = 'https://uvwturgomovjvokojtkp.supabase.co';
    const supabaseKey = 'sb_publishable_a6k4T2_-ksuHVUvCduUlCQ_DtoR9R4F';
    // ✅ 전역명 supabase 충돌 방지: sb 사용
    const sb = window.supabase.createClient(supabaseUrl, supabaseKey);

    /********************
     * 1) 어드민 로그인 체크
     * - 너가 기존에 쓰는 방식이 있으면 여기만 맞춰줘
     ********************/
    function requireAdmin() {
      // 예시: localStorage에 luenai_admin_logged_in = "true"
      const ok = localStorage.getItem('luenai_admin_logged_in');
      if (ok !== 'true') {
        alert('관리자 로그인이 필요합니다.');
        // 너의 어드민 로그인 페이지로
        window.location.href = 'login.html';
      }
    }

    document.getElementById('btnLogout').addEventListener('click', () => {
      localStorage.removeItem('luenai_admin_logged_in');
      alert('로그아웃 되었습니다.');
      window.location.href = 'login.html';
    });

    /********************
     * 2) 상태/유틸
     ********************/
    const el = (id) => document.getElementById(id);
    const fmt = (v) => (v == null ? '-' : Number(v).toLocaleString('ko-KR') + ' 원');
    const showErr = (msg) => { el('errBox').textContent = '❌ 오류: ' + msg; el('errBox').classList.add('show'); el('okBox').classList.remove('show'); };

    // ✅ 누적 실현수익 계산: profit_logs 합산(트리거/컬럼 지연에도 즉시 반영)
    async function getRealizedFromLogs(userId) {
      // 1) PostgREST aggregate 시도
      try {
        const { data, error } = await sb
          .from('profit_logs')
          .select('amount_delta.sum()')
          .eq('user_id', userId);

        if (!error && Array.isArray(data) && data.length) {
          const row = data[0] || {};
          const val = (row.sum ?? row['amount_delta']?.sum ?? Object.values(row)[0]);
          const n = Number(val);
          if (Number.isFinite(n)) return n;
        }
      } catch (e) {
        // ignore and fallback
      }

      // 2) Fallback: 페이지네이션으로 직접 합산
      let total = 0;
      let from = 0;
      const pageSize = 1000;

      while (true) {
        const { data, error } = await sb
          .from('profit_logs')
          .select('amount_delta')
          .eq('user_id', userId)
          .range(from, from + pageSize - 1);

        if (error) throw error;

        const rows = Array.isArray(data) ? data : [];
        for (const r of rows) total += Number(r.amount_delta || 0);

        if (rows.length < pageSize) break;
        from += pageSize;
      }

      return total;
    }

    const showOk  = (msg='✅ 적용 완료') => { el('okBox').textContent = msg; el('okBox').classList.add('show'); el('errBox').classList.remove('show'); };
    const clearMsg = () => { el('okBox').classList.remove('show'); el('errBox').classList.remove('show'); };

    let selectedUser = null; // users row

    function enableApplyButtons(on) {
      el('btnApply').disabled = !on;
    }

    function toKST(iso) {
      if (!iso) return '-';
      const d = new Date(iso);
      return d.toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' });
    }

    /********************
     * 3) 유저 조회
     ********************/
    async function findUserByUsername(username) {
      const { data, error } = await sb
        .from('users')
        .select('id, username, name, realized_amount')
        .eq('username', username)
        .maybeSingle();

      if (error) throw error;
      if (!data) throw new Error('해당 username의 유저를 찾을 수 없습니다.');
      return data;
    }

    async function loadTimeline(userId) {
      const { data, error } = await sb
        .from('profit_logs')
        .select('amount_delta, created_at')
        .eq('user_id', userId)
        .order('created_at', { ascending: false })
        .limit(20);

      if (error) throw error;

      const box = el('timeline');
      box.innerHTML = '';

      if (!data || data.length === 0) {
        box.innerHTML = '<div class="mini">아직 profit_logs 기록이 없습니다.</div>';
        return;
      }

      data.forEach(row => {
        const amt = Number(row.amount_delta || 0);
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `
          <div class="left">
            <div class="who">profit_logs</div>
            <div class="date">${toKST(row.created_at)}</div>
          </div>
          <div class="amt ${amt >= 0 ? 'plus' : 'minus'}">
            ${amt >= 0 ? '+' : ''}${amt.toLocaleString('ko-KR')}원
          </div>
        `;
        box.appendChild(div);
      });
    }

    async function refreshSelectedUser() {
      if (!selectedUser?.username) return;
      const u = await findUserByUsername(selectedUser.username);
      selectedUser = u;

      // ✅ users.realized_amount(트리거) 대신 profit_logs 합산으로 "현재 누적"을 표시
      const realizedNow = await getRealizedFromLogs(u.id);

      el('statArea').style.display = 'flex';
      el('uName').textContent = u.name || u.username || '-';
      el('uId').textContent = 'user_id: ' + u.id;
      el('uRealized').textContent = fmt(realizedNow);

      // realized 색상
      const v = el('uRealized');
      v.classList.remove('positive','negative');
      if (realizedNow > 0) v.classList.add('positive');
      if (realizedNow < 0) v.classList.add('negative');

      el('logTitle').textContent = '선택된 유저: ' + (u.username || '-');
      enableApplyButtons(true);

      await loadTimeline(u.id);
    }

    el('btnFind').addEventListener('click', async () => {
      clearMsg();
      try {
        const username = el('username').value.trim();
        if (!username) return showErr('username을 입력하세요.');

        selectedUser = await findUserByUsername(username);
        await refreshSelectedUser();
        showOk('✅ 유저 조회 완료');
      } catch (e) {
        console.error(e);
        enableApplyButtons(false);
        el('statArea').style.display = 'none';
        el('timeline').innerHTML = '<div class="mini">유저를 조회하면 최근 로그가 표시됩니다.</div>';
        showErr(e?.message || '조회 실패');
      }
    });

    /********************
     * 4) 증감 적용 (profit_logs insert)
     * - 트리거가 users.realized_amount를 자동 반영
     ********************/
    
async function applyDeltaFromInput() {
      clearMsg();

      try {
        if (!selectedUser?.id) return showErr('먼저 유저를 조회하세요.');

        const raw = String(el('deltaAmount').value || '').trim();
        const normalized = raw.replace(/,/g, '').replace(/\s+/g, '');
        if (!raw) return showErr('증감할 금액을 입력하세요. (예: 250000 또는 -250000)');

        const n = Number(normalized);
        if (!Number.isFinite(n) || n === 0) return showErr('0이 아닌 숫자만 입력하세요. (예: 250000 또는 -250000)');

        const delta = n; // ✅ 양수=수익, 음수=손실

        // ✅ profit_logs에 기록 (트리거로 users 반영)
        const { error } = await sb
          .from('profit_logs')
          .insert([{ user_id: selectedUser.id, amount_delta: delta }]);

        if (error) throw error;

        el('deltaAmount').value = '';
        showOk(`✅ ${delta >= 0 ? '+' : ''}${delta.toLocaleString('ko-KR')}원 적용 완료`);

        // DB 반영값 재조회 + 타임라인 갱신
        await refreshSelectedUser();
      } catch (e) {
        console.error(e);
        showErr(e?.message || '적용 실패');
      }
    }

    // ✅ Enter / 확인 버튼으로 적용
    el('btnApply').addEventListener('click', applyDeltaFromInput);
    el('deltaAmount').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') applyDeltaFromInput();
    });

    /********************
     * 5) 시작
     ********************/
    requireAdmin();
    enableApplyButtons(false);
  </script>
</body>
</html>

